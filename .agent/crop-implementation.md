# 图片裁剪功能优化实现

## 概述
实现了自定义裁剪功能,替代 TUI Image Editor 自带的裁剪功能,解决了以下问题:
- ✅ 裁剪后可以撤回,不会直接覆盖原图
- ✅ 可以恢复和调整裁剪范围
- ✅ 裁剪的图片保存后,再次编辑时可以重新调整裁剪范围

## 核心功能

### 1. 自定义裁剪模式
- **进入裁剪模式**: 点击工具栏的裁剪按钮
- **选择裁剪区域**: 拖动绿色虚线框选择裁剪区域
- **调整裁剪范围**: 拖动边角控制点调整大小和位置
- **确认裁剪**: 按 `Enter` 键应用裁剪
- **取消裁剪**: 按 `Esc` 键或再次点击裁剪按钮取消

### 2. 裁剪范围可视化
- 使用半透明绿色矩形显示裁剪区域
- 绿色虚线边框和控制点便于调整
- 裁剪区域外显示为半透明黑色遮罩

### 3. 重新编辑已裁剪图片
当再次点击裁剪按钮编辑已裁剪的图片时:
- 自动恢复原始图片尺寸
- 显示之前的裁剪范围
- 可以重新调整裁剪区域
- 取消时恢复到上次裁剪的状态

## 技术实现

### 状态管理
```typescript
let cropMode = false;                    // 是否处于裁剪模式
let cropRect: fabric.Rect | null = null; // 裁剪矩形对象
let originalImageDimensions = { width: 0, height: 0 }; // 原始图片尺寸
let cropData: { left, top, width, height } | null = null; // 裁剪数据
let isCropped = false;                   // 是否已裁剪
```

### 核心函数

#### enterCropMode()
- **停止绘图模式**: 强制调用 `stopDrawingMode` 防止误触发矩形工具
- 进入裁剪模式
- 如果图片已裁剪,恢复原始尺寸并显示之前的裁剪范围
- **恢复位置**: 还原所有对象及背景图(`backgroundImage`)的坐标
- **调整容器**: 更新 canvas 容器尺寸防止拉伸
- 创建可调整的裁剪矩形
- 显示操作提示

#### exitCropMode(apply: boolean)
- 退出裁剪模式
- `apply=true`: 应用裁剪
- `apply=false`: 取消裁剪
  - 如果之前是裁剪状态,恢复到裁剪后的尺寸和位置
  - 还原所有对象及背景图的坐标
  - 更新 canvas 容器尺寸

#### applyCrop()
- 应用裁剪操作
- **位置调整**: 调整所有对象及背景图(`backgroundImage`)的位置
- **尺寸更新**: 更新 Canvas 及其容器(`wrapper`)的尺寸,防止视觉变形
- 保存裁剪数据

#### setupCropButton()
- 隐藏 TUI 原生裁剪按钮
- 创建自定义裁剪按钮
- 添加点击事件处理

### 元数据存储
裁剪信息保存在 PNG 元数据中:
```json
{
  "version": 1,
  "originalFileName": "image.png",
  "originalBlockId": "...",
  "originalBackupPath": "...",
  "canvasJSON": {...},
  "cropData": {
    "left": 100,
    "top": 50,
    "width": 800,
    "height": 600
  },
  "originalImageDimensions": {
    "width": 1000,
    "height": 800
  }
}
```

### 键盘快捷键
- `Enter`: 确认裁剪
- `Esc`: 取消裁剪或退出裁剪模式

## 用户体验改进

1. **视觉反馈**
   - 裁剪按钮在激活时显示绿色高亮
   - 裁剪区域使用绿色虚线边框
   - 显示操作提示消息

2. **操作流程**
   - 点击裁剪 → 调整范围 → Enter 确认
   - 支持多次调整裁剪范围
   - 可以随时取消操作

3. **数据持久化**
   - 裁剪信息保存在图片元数据中
   - 再次编辑时自动恢复裁剪状态
   - 支持重新调整裁剪范围

## 与原有功能的集成

- 隐藏了 TUI Image Editor 的原生裁剪按钮
- 自定义裁剪按钮插入到工具栏最前面
- 与其他编辑功能(标注、绘图等)完全兼容
- 裁剪数据与画布状态一起保存和恢复
